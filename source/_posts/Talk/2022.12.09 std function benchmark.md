---
title: 2022.12.09 std function benchmark
categories:
- Talk
---
源代码

```cpp
#include <ctime>
#include <functional>
#include <iostream>

int cnt;

void foo(void (*func)()) { func(); }
void foo2(std::function<void()> func) { func(); }

int main() {
    std::cout << "Working with pointer function" << std::endl;
    for (char c = 0; c < 10; ++c) {
        auto time = clock();
        cnt = 0;
        for (int i = 0; i < 2147483647; ++i) {
            foo([]() -> void { ++cnt; });
        }
        auto duration = clock() - time;
        std::cout << "Pointer Function #" << c + 1 << ": " << (duration * 1.0 / CLOCKS_PER_SEC) << std::endl;
    }

    std::cout << "Working with std::function" << std::endl;
    for (char c = 0; c < 10; ++c) {
        auto time = clock();
        cnt = 0;
        for (int i = 0; i < 2147483647; ++i) {
            foo2([]() -> void { ++cnt; });
        }
        auto duration = clock() - time;
        std::cout << "std::function #" << c + 1 << ": " << (duration * 1.0 / CLOCKS_PER_SEC) << std::endl;
    }
    return 0;
}
```

环境：
- 处理器：Intel i7-8565u
- 编译器：clang(15.0.6)
- 操作系统：Ubuntu 22.04 Desktop

结果：
- 编译命令：`clang++ -O0 test.cpp -o test`。
  
  输出结果：

  ```
  Working with pointer function
  Pointer Function #1: 8.85245
  Pointer Function #2: 8.78011
  Pointer Function #3: 8.70156
  Pointer Function #4: 9.34686
  Pointer Function #5: 9.40801
  Pointer Function #6: 9.45007
  Pointer Function #7: 9.41338
  Pointer Function #8: 9.39224
  Pointer Function #9: 9.46751
  Pointer Function #10: 9.42704
  Working with std::function
  std::function #1: 77.2297
  std::function #2: 77.0827
  std::function #3: 76.7105
  std::function #4: 76.9663
  std::function #5: 76.934
  std::function #6: 77.1515
  std::function #7: 76.9874
  std::function #8: 76.9763
  std::function #9: 77.1421
  std::function #10: 77.1322
  ```
- 编译命令：`clang++ -O0 -stdlib=libc++ test.cpp -o test`。
  
  输出结果：

  ```
  Working with pointer function
  Pointer Function #1: 8.24743
  Pointer Function #2: 8.16119
  Pointer Function #3: 8.16398
  Pointer Function #4: 8.58967
  Pointer Function #5: 8.93652
  Pointer Function #6: 8.89022
  Pointer Function #7: 8.95337
  Pointer Function #8: 8.85758
  Pointer Function #9: 8.85165
  Pointer Function #10: 8.84683
  Working with std::function
  std::function #1: 125.363
  std::function #2: 125.553
  std::function #3: 125.237
  std::function #4: 125.376
  std::function #5: 125.365
  std::function #6: 125.283
  std::function #7: 125.574
  std::function #8: 125.152
  std::function #9: 125.473
  std::function #10: 125.409
  ```

- 编译命令：`g++ -O0 test.cpp -o test`

  输出结果

  ```
  Working with pointer function
  Pointer Function #1: 11.9554
  Pointer Function #2: 11.7381
  Pointer Function #3: 11.8036
  Pointer Function #4: 12.6214
  Pointer Function #5: 12.5371
  Pointer Function #6: 12.5449
  Pointer Function #7: 12.4985
  Pointer Function #8: 12.5306
  Pointer Function #9: 12.5131
  Pointer Function #10: 12.4898
  Working with std::function
  std::function #1: 117.744
  std::function #2: 117.826
  std::function #3: 117.696
  std::function #4: 117.954
  std::function #5: 117.751
  std::function #6: 118.016
  std::function #7: 117.829
  std::function #8: 117.767
  std::function #9: 117.776
  std::function #10: 117.101
  ```

- 编译命令：`clang++ -O2 test.cpp -o test`

  输出结果

  ```
  Working with pointer function
  Pointer Function #1: 2e-06
  Pointer Function #2: 1e-06
  Pointer Function #3: 1e-06
  Pointer Function #4: 1e-06
  Pointer Function #5: 0
  Pointer Function #6: 1e-06
  Pointer Function #7: 1e-06
  Pointer Function #8: 2e-06
  Pointer Function #9: 1e-06
  Pointer Function #10: 1e-06
  Working with std::function
  std::function #1: 1e-06
  std::function #2: 1e-06
  std::function #3: 1e-06
  std::function #4: 0
  std::function #5: 1e-06
  std::function #6: 1e-06
  std::function #7: 1e-06
  std::function #8: 1e-06
  std::function #9: 1e-06
  std::function #10: 1e-06
  ```