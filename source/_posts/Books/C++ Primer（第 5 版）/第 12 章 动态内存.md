---
title: 第 12 章 动态内存
categories:
- Book
- C++ Primer （第 5 版）
---
# 12.1 动态内存与智能指针

- 智能指针英文：`smart pointer`。
- 智能指针默认需要指向 `new` 申请的内存。
- `shared_ptr` 的成员函数 `use_count` 可能很慢主要用于调试。
- 若将 `shared_ptr` 存放在容器中，随后不再需要里面的部分元素（例如大部分时候的 `unique` 操作 ），那么应当手动 `erase` 不需要的元素以确保释放 `shared_ptr`。
- 向 `new` 提供单一的初始化器可以使用 `auto` 获得类型。
- 如果 `new` 内存请求失败，会抛出 `bad_alloc` 错误，可以在 `new` 后添加 `(nothrow)` 指定错误时返回空指针。
- 空置指针：指向一块曾经保存数据对象但现在已经无效的内存的指针。
- 默认情况下，一个用来初始化智能指针的普通指针必须指向动态内存，因为默认使用 `delete` 释放它所关联的对象。
- `reset` 函数可以将当前 `shared_ptr` 置为空指针，可以传入新的内置指针覆盖当前指向目标，还可以传入可调用对象来覆盖新目标释放时的方式。
- 混用智能指针和普通指针的一种错误：
  
  ```cpp
  void process(std::shared_ptr<int> ptr) {}

  int main() {
    std::shared_ptr<int> x(new int(42));
    process(std::shared_ptr<int>(x));
    int j = *x; // 空置指针
    return 0;
  }
  ```

  传入 `process` 时，语句结束后智能指针被销毁，会将 `x` 指向元素进行释放，因此之后 `x` 变成了空置指针。

- `get` 函数可以获得一个内置指针，这个指针不可被 `delete`，同时不应用来初始化另一个智能指针，因为它们的计数是分开的。
- `shared_ptr` 可以用于协助管理一些没有没有析构函数的类，例如第三方的网络连接类可能出于兼容性的考虑，没有提供析构函数。
- `unique_ptr`：
  - 尖括号接受必选的指向类型与一个可选的可调用对象类型用于释放。初始化时括号仅接受一个参数为释放时调用的对象。
  - `release`：放弃控制权同时置空。返回指针。同 `reset` 不同在于不会释放对象。
  - `reset`：释放对象，如果提供了参数，指向参数所指对象，否则置空。
  - 可以在一部分情况下拷贝（例如函数返回）。
- `weak_ptr`：
  - 类似 `shared_ptr`，但是不会更改计数。
  - `expired`：`use_count` 是否为 `0`。'
  - `lock`：若尚未 `expired`，返回指向对象的 `shared_ptr`，否则返回空 `shared_ptr`。
  - 必须使用 `lock` 返回结果访问对象。

# 12.2 动态数组

- 分配动态数组内存时，长度可以为 `0`，但是此时返回的指针不能解引用。此时返回的指针是非空的且与其他的任何指针都不相同（类似尾后指针）。
- 释放动态数组内存时，应当在 `delete` 后添加 `[]`，这个时候按照逆序释放内存。
- `shared_ptr` 不支持管理动态数组（需要自行添加删除器），且未定义下标运算符，必须使用 `get()` 获取指针，`unique_ptr` 管理动态数组时应当使用 `[]` 访问其元素。
- `allocator`:
  - `allocate(n)`：分配 `n` 个元素的内存，返回指针。
  - `deallocate(p, n)`：`p` 是之前从 `allocate` 返回的指针，`n` 必须为 `allocate` 时要求的大小。要求释放的内存必须调用过 `destroy`。
  - `construct(p, args)`：`p` 是指针，`args` 是构造函数。
  - `destroy(p)`：析构。
  
  伴随算法：

  - `uninitialized_copy(b, e, b2)`：从迭代器 `b` 和 `e` 指出的输入范围拷贝元素到 `b2` 指定的未构造的原始内存。
  - `uninitialized_copy_n(b, n, b2)`：用个数而非尾后迭代器指定范围。
  - `uninitialized_fill(b, e, t)`：用 `t` 的拷贝初始化指定范围。
  - `uninitialized_fill_n(b, n, t)`：用个数而非尾后迭代器指定范围。

# 12.3 使用标准库：文本查询程序